---
title: "Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’google-authã¨oauthlibã‚’ä½¿ã£ã¦å–å¾—ã™ã‚‹"
emoji: "ğŸ“…"
type: "tech"
topics: ["python", "oauth", "googlecalendar"]
published: true
publication_name: "pytokyo"
---

Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æƒ…å ±ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å–å¾—ã—ãŸã„å ´åˆã€Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®access_tokenã¨refresh_tokenãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚’å–å¾—ã™ã‚‹ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®èªè¨¼ã‚’æ±‚ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

iOS/Androidã‚¢ãƒ—ãƒªã§Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼ã‚’å–ã‚‹å ´åˆã€ã‚¢ãƒ—ãƒªå´ã§auth_codeã‚’å–å¾—ã—ã€ãã‚Œã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«é€ä¿¡ã—ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å´ã§auth_codeã‚’ä½¿ã£ã¦Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®access_tokenã¨refresh_tokenã¨äº¤æ›ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

å…¬å¼ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã¯[ã“ã¡ã‚‰](https://developers.google.com/identity/sign-in/android/offline-access)ã‚„[ã“ã¡ã‚‰](https://developers.google.com/identity/sign-in/ios/offline-access)ã§ã™ãŒã€**ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å´ã®Pythonã‚³ãƒ¼ãƒ‰ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹oauth2clientã¯ã™ã§ã«éæ¨å¥¨ã«ãªã£ã¦ã„ã¾ã™ã€‚** ãã®ãŸã‚ã€ä»£ã‚ã‚Šã«åˆ©ç”¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ google-auth ã¨  oauthlib ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã«ã‚‚é–¢ã‚ã‚‰ãšã€ã‚¢ãƒ—ãƒªã§å–å¾—ã—ãŸ auth_code ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ access_token ã¨ refresh_token ã«äº¤æ›ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒ**å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã©ã“ã‚ã‹ã„ãã‚‰æ¢ã›ã©è¦‹ã¤ã‹ã‚‰ãšã€ã‚ã£ã¡ã‚ƒè‹¦åŠ´ã—ã¾ã—ãŸã€‚** ã®ã§ã€ã¡ã‚ƒã‚“ã¨å‹•ã„ãŸã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¾ã™ã€‚

```python
from google_auth_oauthlib.flow import Flow

flow = Flow.from_client_secrets_file(
           '/path/to/client_secret.json',
           scopes=[
               'openid',
               'https://www.googleapis.com/auth/userinfo.profile',
               'https://www.googleapis.com/auth/userinfo.email',
               'https://www.googleapis.com/auth/calendar'
           ]
       )

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å–å¾—ã—ãŸauth_codeã‚’æ¸¡ã™
credentials = flow.fetch_token(code=auth_code)


print(credentials.get('access_token'))
print(credentials.get('refresh_token'))
print(credentials.get('id_token'))
```

google_auth_oauthlibã®Flowã‚’ä½¿ã„ã¾ã™ã€‚Googleã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å–å¾—ã§ãã‚‹client_secret.jsonã‚’é©å½“ãªå ´æ‰€ã«ãŠã„ã¦ã€ãã®ãƒ‘ã‚¹ã‚’ç¬¬ä¸€å¼•æ•°ã€èªè¨¼ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç¬¬äºŒå¼•æ•°ã«æ¸¡ã—ã¾ã™ã€‚ã“ã®ã¨ãã€**ç¬¬äºŒå¼•æ•°ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¯ã‚¢ãƒ—ãƒªã§auth_codeã‚’å–å¾—ã™ã‚‹ã¨ãã®ã‚¹ã‚³ãƒ¼ãƒ—ã¨ä¸€è‡´ã•ã›ã¦ãã ã•ã„ã€‚**

ã‚ã¨ã¯ã€`flow.fetch_token(code=auth_code)`ã™ã‚Œã°ã€dictãŒå¸°ã£ã¦ãã‚‹ã®ã§ãã‚Œãã‚Œã€`.get('access_token')`ã€`.get('refresh_token')`ã§Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã¾ã™ã€‚

id_tokenã«ã¤ã„ã¦ã¯è©³ã—ã„èª¬æ˜ã‚’å‰²æ„›ã—ã¾ã™ãŒã€ã“ã‚Œã‚’ä½¿ã£ã¦emailã‚„nameã‚’å–å¾—ã—ã¾ã™ã€‚

```python
from google.oauth2 import id_token
from google.auth.transport.requests import Request

decoded_token = id_token.verify_oauth2_token(
   credentials.get('id_token'),
   Request(),
   'YOUR_GOOGLE_OAUTH2_CLIENT_ID'
)

if decoded_token.get('iss') not in ['accounts.google.com', 'https://accounts.google.com']:
   raise ValueError('Invalid oauth issuer.')

print(decoded_token.get('email'))
print(decoded_token.get('name'))
```

æ™®é€šã«ã‚ã‚Šãã†ãªçŠ¶æ³ãªã®ã«ã€æ—¥æœ¬èªã‚‚è‹±èªã‚‚æƒ…å ±ãŒå°‘ãªãã¦ã‹ãªã‚Šè‹¦åŠ´ã—ã¾ã—ãŸã€‚è‹±èªã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚æœªã ã«éæ¨å¥¨ã®oauth2clientãªã®ã§ã€oauth2clientãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
