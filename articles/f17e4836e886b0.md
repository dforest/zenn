---
title: "UE4ã®Androidã‚¢ãƒ—ãƒªå†…èª²é‡‘ã¯éæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã«æœªå¯¾å¿œã€‚ä½•ã‚‚ã—ãªã„ã¨æ‰•ã„æˆ»ã•ã‚Œã‚‹å•é¡Œã¨å¯¾å‡¦æ³•"
emoji: "ğŸ“±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["UE4", "Android"]
published: true
publication_name: "pytokyo"
---

Unreal Engineã¯2022å¹´2æœˆç¾åœ¨ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€4.27.2ï¼ˆ5.0.0-early-access-2ã‚‚ï¼‰æ™‚ç‚¹ã§Androidã‚¢ãƒ—ãƒªå†…èª²é‡‘ã®éæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã®å‡¦ç†ã«å¯¾å¿œã§ãã¦ã„ã¾ã›ã‚“ã€‚
ã“ã‚Œã«åˆ¥é€”å¯¾å¿œã›ãšã«éæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’å®Ÿè£…ã—ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã¨ã€Androidã®ã‚¢ãƒ—ãƒªå†…èª²é‡‘ã§è³¼å…¥ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã¯3æ—¥å¾Œã«å¿…ãšæ‰•ã„æˆ»ã—ãŒç™ºç”Ÿã—ã¾ã™ã€‚ï¼ˆiOSã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚è©³ã—ãã¯å¾Œè¿°ã€‚ï¼‰

ã“ã®è¨˜äº‹ã§ã¯ã“ã®å•é¡Œã®åŸå› ã¨å¯¾å‡¦æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

![](/images/20220215/play_console_notice.png)

:::message
å¯¾å¿œã›ãšã«ãƒªãƒªãƒ¼ã‚¹ã—ã¦ã‚¢ã‚¤ãƒ†ãƒ ãŒè³¼å…¥ã•ã‚Œã‚‹ã¨ã€ä¸Šã®ã‚ˆã†ãªæ‚²ã—ã„ãŠçŸ¥ã‚‰ã›ãŒGoogle Play Consoleã«å±Šãã¾ã™ã€‚
:::

# iOS/Androidã«ãŠã‘ã‚‹æ¶ˆè²»å‹ã¨éæ¶ˆè²»å‹ã®é•ã„

ã”å­˜çŸ¥ã®é€šã‚Šã€ã‚¢ãƒ—ãƒªå†…èª²é‡‘ã«ã¯æ¶ˆè²»ã™ã‚‹ã“ã¨ã§ä½•åº¦ã‚‚è³¼å…¥ã§ãã‚‹ã€Œæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã€ã¨ã€1å›ã—ã‹è³¼å…¥ã§ããšæ¶ˆè²»ã¨ã„ã†æ¦‚å¿µãŒãªã„ã€Œéæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã€ã®2ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚

iOSã¯App Store Connectã§ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç™»éŒ²ã™ã‚‹éš›ã«æ¶ˆè²»å‹ï¼ˆæ¶ˆè€—å‹ï¼‰ã€éæ¶ˆè²»å‹ï¼ˆéæ¶ˆè€—å‹ï¼‰ã‚’é¸ã¶ãŸã‚ç™»éŒ²å®Œäº†ã—ãŸã¨ãã«ã©ã¡ã‚‰ã®ã‚¿ã‚¤ãƒ—ã‹ãŒç¢ºå®šã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚iOSã®éæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã¯è³¼å…¥ã™ã‚‹ã ã‘ã§å‡¦ç†ãŒå®Œäº†ã—ã€ç‰¹åˆ¥ãªå‡¦ç†ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚

> æ¶ˆè€—å‹
> ã‚²ãƒ¼ãƒ å†…ã§ã®é€²æ—ã‚’ä¿ƒã™ãƒ©ã‚¤ãƒ•ã‚„å®çŸ³ã€ãƒ‡ãƒ¼ãƒˆAppã§ã®è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®è¡¨ç¤ºé »åº¦ã‚’å‘ä¸Šã™ã‚‹ãŸã‚ã®ãƒ–ãƒ¼ã‚¹ãƒˆãªã©ã€æ§˜ã€…ãªç¨®é¡ã®æ¶ˆè€—å‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’æä¾›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ¶ˆè€—å‹ã®Appå†…èª²é‡‘ã¯ä¸€åº¦ä½¿ã†ã¨ãªããªã‚Šã€å†åº¦è³¼å…¥ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ãƒ•ãƒªãƒ¼ãƒŸã‚¢ãƒ ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†Appã‚„ã‚²ãƒ¼ãƒ ã§ã‚ˆãæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚
>
> éæ¶ˆè€—å‹
> ä¸€åº¦è³¼å…¥ã™ã‚Œã°ç„¡æœŸé™ã«ä½¿ç”¨ã§ãã‚‹ã€éæ¶ˆè€—å‹ã®ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€å†™çœŸAppã®è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿ã€ã‚¤ãƒ©ã‚¹ãƒˆä½œæˆAppã®è¿½åŠ ãƒ–ãƒ©ã‚·ã€ã‚²ãƒ¼ãƒ ã®ã‚³ã‚¹ãƒ¡ãƒ†ã‚£ãƒƒã‚¯ã‚¢ã‚¤ãƒ†ãƒ ãªã©ãŒã‚ã‚Šã¾ã™ã€‚éæ¶ˆè€—å‹ã®è³¼å…¥ã‚¢ã‚¤ãƒ†ãƒ ã§ã¯ã€ãƒ•ã‚¡ãƒŸãƒªãƒ¼å…±æœ‰ã‚’æä¾›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://developer.apple.com/jp/in-app-purchase/

ä¸€æ–¹ã€Androidã¯ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç™»éŒ²ã™ã‚‹éš›ã«ã¯ã©ã¡ã‚‰ã®ã‚¿ã‚¤ãƒ—ã‹ã¯æ±ºã‚ã‚‰ã‚Œãšã€å®Ÿéš›ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³¼å…¥ã—ãŸã‚ã¨ã®å‡¦ç†ã§ã©ã¡ã‚‰ã®ã‚¿ã‚¤ãƒ—ã«ã™ã‚‹ã‹ãŒå‹•çš„ã«æ±ºã¾ã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå•†å“ã‚’è³¼å…¥ã—ãŸã‚ã¨ã€æ¶ˆè²»ï¼ˆConsumeï¼‰å‡¦ç†ã‚’ã—ãŸå ´åˆã¯æ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã«ãªã‚Šã€æ‰¿èªï¼ˆAcknowledgeï¼‰å‡¦ç†ã‚’ã—ãŸå ´åˆã¯éæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã«ãªã‚Šã¾ã™ã€‚

> æ¶ˆè²»å¯èƒ½ã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆã€consumeAsync() ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ‰¿èªè¦ä»¶ã‚’å±¥è¡Œã—ã€ã‚¢ãƒ—ãƒªãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ©ç”¨æ¨©ã‚’ä»˜ä¸ã—ãŸã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã¯ 1 å›é™ã‚Šã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å†è³¼å…¥å¯èƒ½ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

> æ¶ˆè²»ä¸å¯ã‚¢ã‚¤ãƒ†ãƒ ã®è³¼å…¥ã‚’æ‰¿èªã™ã‚‹ã«ã¯ã€Google Play Billing Library ã® BillingClient.acknowledgePurchase() ã¾ãŸã¯ Google Play Developer API ã® Product.Purchases.Acknowledge ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚è³¼å…¥ã‚’æ‰¿èªã™ã‚‹å‰ã«ã€ã‚¢ãƒ—ãƒªã¯ Google Play Billing Library ã® isAcknowledged() ãƒ¡ã‚½ãƒƒãƒ‰ã¾ãŸã¯ Google Developers API ã® acknowledgementState ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€è³¼å…¥ãŒã™ã§ã«æ‰¿èªã•ã‚Œã¦ã„ãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

:::message
éå¸¸ã«ã‚ã‹ã‚Šã«ãã„ã§ã™ãŒã€Google Playã‚¢ãƒ—ãƒªå†…èª²é‡‘ã®èª¬æ˜ã§ã¯ã€Œ1å›é™ã‚Šã®ã‚¢ã‚¤ãƒ†ãƒ ã€= ã€Œå®šæœŸè³¼å…¥ã§ã¯ãªã„ã‚¢ã‚¤ãƒ†ãƒ ã€ã®ã“ã¨ã§éæ¶ˆè²»å‹ï¼ˆæ¶ˆè²»ä¸å¯ï¼‰ã®ã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
:::

https://developer.android.com/google/play/billing/integrate?hl=ja#process

ãã—ã¦ç¾åœ¨ã®Unreal Engineã«ã¯**æ‰¿èªï¼ˆAcknowledgeï¼‰å‡¦ç†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆ!?ï¼‰ã€‚**

# Unreal Engineã§ã®Androidã‚¢ãƒ—ãƒªå†…èª²é‡‘å®Ÿè£…ã®å•é¡Œç‚¹

https://docs.unrealengine.com/4.27/ja/SharingAndReleasing/Mobile/InAppPurchases/

Unreal Engineã§ã®ã‚¢ãƒ—ãƒªå†…èª²é‡‘å®Ÿè£…ã¯åŸºæœ¬çš„ã«ã¯ä¸Šã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã‹ã‚Œã¦ã„ã‚‹é€šã‚Šãªã®ã§ã™ãŒã€

- `Make In-App Purchase V2`ãƒãƒ¼ãƒ‰ã‚’ä½¿ã†ã¨å‹•ã‹ãªã„
- `Restore In-App Purchases`ãƒãƒ¼ãƒ‰ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ãªã„`Consumable Product Flags`ã¨ã„ã†å¼•æ•°ãŒã‚ã‚‹
- æ¶ˆè²»(Consume)å‡¦ç†ã‚’ã™ã‚‹ã«ã¯`Restore In-App Purchases`ãƒãƒ¼ãƒ‰ã‚’ä½¿ã†ã—ã‹ãªã„
- ã“ã“ã«æ›¸ã‹ã‚Œã¦ã„ãªã„`Query for Owned Purchases`ãƒãƒ¼ãƒ‰ãŒã‚ã‚‹

ãªã©ã€ãªã‹ãªã‹ç™–ãŒã‚ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚Unreal Engineã§ã®ã‚¢ãƒ—ãƒªå†…èª²é‡‘ã®è©³ã—ã„å®Ÿè£…æ–¹æ³•ã¯ã€æ”¹ã‚ã¦åˆ¥ã®è¨˜äº‹ã«ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

ãã—ã¦æœ¬é¡Œã§ã™ã€‚å‰è¿°ã®é€šã‚Šã€**Androidã§è³¼å…¥ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’éæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã«ã™ã‚‹æ‰¿èª(Acknowledge)å‡¦ç†ã¯ã€ã©ã®ãƒãƒ¼ãƒ‰ã«ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å®Œå…¨ã«ç½ ã§ã™ã€‚** ä½•ã‚‚ã›ãšã«ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã¨ã€è³¼å…¥ã®3æ—¥å¾Œã«ã¯è‡ªå‹•çš„ã«æ‰•ã„æˆ»ã—ã•ã‚Œã¾ã™ã€‚ï¼ˆãƒ†ã‚¹ãƒˆè³¼å…¥ã®å ´åˆã¯10åˆ†ã»ã©ã§æ‰•ã„æˆ»ã—ã•ã‚Œã¾ã™ã€‚ï¼‰

![](/images/20220215/unreal_iap_doc_image_4.jpg)

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®`è³¼å…¥ã®å®Œäº†`ã«ã¯ã“ã®ã‚ˆã†ãªç”»åƒãŒã‚ã£ã¦ã€`Make InAppPurchaseProductRequest`ãƒãƒ¼ãƒ‰ã«`Is Consumable`ã¨ã„ã†ã„ã‹ã«ã‚‚ãªå¼•æ•°ãŒã‚ã‚‹ã®ã§ã€å½ãªã‚‰æ‰¿èªå‡¦ç†ã‚’å†…éƒ¨çš„ã«ã‚„ã£ã¦ãã‚Œã‚‹ã®ã‹ã¨æ€ã„ãã‚„ãã‚“ãªã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚€ã—ã‚ã“ã®å¼•æ•°ã¯**è³¼å…¥å‡¦ç†å†…ã§åˆ©ç”¨ã™ã‚‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆiOSã¯æœªç¢ºèªï¼‰ã€‚**

ã¡ãªã¿ã«ã€`Restore In-App Purchases`ã®`Consumable Product Flags`ã«`Is Consumable`ã‚’trueã«ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¥ã‚Œã‚‹ã¨**è©²å½“ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯æ¶ˆè²»(Consume)å‡¦ç†ã•ã‚Œã¦ã—ã¾ã†ã®ã§éæ¶ˆè²»å‹ã«ã—ãŸã„ã‚¢ã‚¤ãƒ†ãƒ ã«å¯¾ã—ã¦ã¯çµ¶å¯¾ã«ã‚„ã£ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚**

ä¸‹è¨˜ãŒå®Ÿéš›ã®UE4ã«å«ã¾ã‚Œã‚‹Androidã®è³¼å…¥å‡¦ç†ã¾ã‚ã‚Šã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚èª²é‡‘å®Ÿè£…ã‚’ã™ã‚‹å‰ã«èª­ã‚“ã§ãŠãã¨ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ï¼ˆã¨ã„ã†ã‹èª­ã‚“ã§ãŠã‹ãªã„ã¨æƒ³å®šå¤–ã®å‹•ãã‚’ã™ã‚‹ã®ã§æ€–ã„ï¼‰ã€‚

https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Plugins/Online/Android/OnlineSubsystemGooglePlay/Source/Java/BillingApiV2/com/epicgames/ue4/GooglePlayStoreHelper.java

:::message
è¦‹ã‚Œãªã„å ´åˆã¯ã“ã¡ã‚‰ã®æ‰‹é †ã‚’è¸ã‚“ã§ãã ã•ã„ã€‚
https://www.unrealengine.com/ja/ue4-on-github
:::

ã¾ãŸã€ãƒ­ãƒ¼ã‚«ãƒ«ã«Unreal EngineãŒã‚ã‚‹å ´åˆã¯`Program Files\Epic Games\UE_4.27\Engine\Plugins\Online\Android\OnlineSubsytemGooglePlay\Source\Java\BillingApiV2\com\EpicGames\ue4\GooglePlayStoreHelper.java`ã«ã‚‚åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã§ãã‚Œã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼ˆWindowsã®å ´åˆï¼‰ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯Unreal Engineã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã‚„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦å¤šå°‘ç•°ãªã‚Šã¾ã™ã€‚

# Androidã§éæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã®æ‰¿èªå‡¦ç†ã‚’ã™ã‚‹æ–¹æ³•

ã“ã®å•é¡Œã®å¯¾å‡¦æ³•ã§ã™ã€‚æ–¹æ³•ã«ã¯ä»¥ä¸‹ã®2ç¨®é¡ã‚ã‚Šã¾ã™ã€‚

- ã‚¨ãƒ³ã‚¸ãƒ³ã‚³ãƒ¼ãƒ‰ã«ãƒ‘ãƒƒãƒã‚’å½“ã¦ã¦æ‰¿èªå‡¦ç†ã‚’ã™ã‚‹ï¼ˆã‚¢ãƒ—ãƒªå†…ã§å®Œçµã•ã›ã‚‹ï¼‰
- Google Play Developer APIçµŒç”±ã§æ‰¿èªå‡¦ç†ã‚’ã™ã‚‹ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚‹ï¼‰

é †ã«èª¬æ˜ã—ã¾ã™ã€‚

## ã‚¨ãƒ³ã‚¸ãƒ³ã‚³ãƒ¼ãƒ‰ã«ãƒ‘ãƒƒãƒã‚’å½“ã¦ã¦æ‰¿èªå‡¦ç†ã‚’ã™ã‚‹

å•é¡Œã®`GooglePlayStoreHelper.java`ã«æ‰¿èª(Acknowledge)å‡¦ç†ã‚’è¶³ã™æ–¹æ³•ã§ã™ã€‚ã“ã®ãƒ‘ãƒƒãƒã‚’å½“ã¦ãŸUnreal Engineãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ãƒ“ãƒ«ãƒ‰ã™ã‚Œã°ã€æ‰¿èªå‡¦ç†ãŒèµ°ã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§æ¯”è¼ƒçš„æ¥½ã«å°å…¥ã§ãã¾ã™ã€‚

æ‰¿èªå‡¦ç†ã¯è³¼å…¥ã®å®Œäº†æ™‚ï¼ˆ`Make InAppPurchaseProductRequest`ãƒãƒ¼ãƒ‰å®Ÿè¡Œæ™‚ï¼‰ã¨è³¼å…¥ã®å¾©å…ƒæ™‚ï¼ˆ`Restore In-App Purchases`ãƒãƒ¼ãƒ‰å®Ÿè¡Œæ™‚ï¼‰ã®2ç®‡æ‰€ã«å…¥ã‚Œã¾ã™ã€‚å¾©å…ƒæ™‚ã«å…¥ã‚Œã‚‹ã®ã¯ã€`Make InAppPurchaseProductRequest`ãƒãƒ¼ãƒ‰ã®å‡¦ç†ãŒçµ‚ã‚ã£ã¦ã‚‚ã‚¢ã‚¤ãƒ†ãƒ ã®è³¼å…¥çŠ¶æ…‹ãŒæ”¯æ‰•ã„å¾…ã¡ï¼ˆPending Purchaseï¼‰ã«ãªã‚‹å ´åˆãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚æ”¯æ‰•ã„å¾…ã¡ã‚¢ã‚¤ãƒ†ãƒ ãŒæ”¯æ‰•ã„æ¸ˆã¿ã«ãªã£ãŸã“ã¨ã¯Restoreå‡¦ç†ã®ä¸­ã§ã‚ã‹ã‚‹ã®ã§ã€ãã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚‚æ‰¿èªå‡¦ç†ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

:::message
ã©ã†ã„ã£ãŸå ´åˆã«æ”¯æ‰•ã„å¾…ã¡çŠ¶æ…‹ã«ãªã‚‹ã‹ã¯ã“ã¡ã‚‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ãŒè©³ã—ã„ã§ã™ã€‚
https://speakerdeck.com/syarihu/re-zero-starting-uses-of-play-billing-library?slide=15
:::

ãƒ‘ãƒƒãƒã‚’å½“ã¦ã‚‹è©²å½“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯`Program Files\Epic Games\UE_4.27\Engine\Plugins\Online\Android\OnlineSubsytemGooglePlay\Source\Java\BillingApiV2\com\EpicGames\ue4\GooglePlayStoreHelper.java`ã§ã™ï¼ˆWindowsã®å ´åˆï¼‰ã€‚

### è³¼å…¥å‡¦ç†å¾Œã«æ‰¿èªã™ã‚‹ãƒ‘ãƒƒãƒ

```java:GooglePlayStoreHelper.java
  /**
   * Route taken by the Purchase workflow. We listen for our purchaseIntentIdentifier request code and
   * handle the response accordingly
   */
  public boolean onPurchaseResult(BillingResult billingResult, Purchase purchase)
  {
    ...

      if(purchase.getPurchaseState() == Purchase.PurchaseState.PURCHASED)
      {
        final String sku = purchase.getSku();
        final Purchase f_purchase = purchase;
        Handler mainHandler = new Handler(Looper.getMainLooper());
        mainHandler.post(new Runnable()
        {
          @Override
          public void run()
          {
            String receipt = Base64.encode(f_purchase.getOriginalJson().getBytes());

            // START: Patch for acknowledge purchase
            AcknowledgePurchaseParams acknowledgePurchaseParams = AcknowledgePurchaseParams.newBuilder().setPurchaseToken(f_purchase.getPurchaseToken()).build();
            AcknowledgePurchaseResponseListener acknowledgePurchaseResponseListener = new AcknowledgePurchaseResponseListener() {
              @Override
              public void onAcknowledgePurchaseResponse(BillingResult billingResult) {
                //getMessage("Purchase acknowledged");
              }
            };
            mBillingClient.acknowledgePurchase(acknowledgePurchaseParams,acknowledgePurchaseResponseListener);
            // END: Patch for acknowledge purchase

            nativePurchaseComplete(BillingClient.BillingResponseCode.OK, sku, f_purchase.getPurchaseToken(), receipt, f_purchase.getSignature());
          }
        });
      }
    ...
  }
```

### ãƒªã‚¹ãƒˆã‚¢å‡¦ç†ã§æ”¯æ‰•ã„æ¸ˆã¿ã‚’æ‰¿èªã™ã‚‹ãƒ‘ãƒƒãƒ

```java:GooglePlayStoreHelper.java
  /**
   * Restore previous purchases the user may have made.
   */
  public boolean RestorePurchases(String[] InProductIDs, boolean[] bConsumable)
  {
    ...
              // How do we get purchase here.. need to figure out a way to persist cachedResponse and receipts
              Log.debug("[GooglePlayStoreHelper] - GooglePlayStoreHelper::RestorePurchases - Purchase restored for " + constProduct.getSku());
              String receipt = Base64.encode(constProduct.getOriginalJson().getBytes());
              receipts.add(receipt);

              f_ownedSkus.add(constProduct.getSku());
              f_signatureList.add(constProduct.getSignature());

              // START: Patch for acknowledge purchase
              AcknowledgePurchaseParams acknowledgePurchaseParams = AcknowledgePurchaseParams.newBuilder().setPurchaseToken(ownedProduct.getPurchaseToken()).build();
                AcknowledgePurchaseResponseListener acknowledgePurchaseResponseListener = new AcknowledgePurchaseResponseListener() {
                  @Override
                public void onAcknowledgePurchaseResponse(BillingResult billingResult) {
                  //getMessage("Purchase acknowledged");
                }
              };
                mBillingClient.acknowledgePurchase(acknowledgePurchaseParams,acknowledgePurchaseResponseListener);
              // END: Patch for acknowledge purchase
            }
          }
    ...
  }
```

ã‚³ãƒ¼ãƒ‰å…¨ä½“ã¯ã“ã¡ã‚‰ã®Gistã«ç½®ãã¾ã—ãŸã€‚

https://gist.github.com/dforest/5a529b01dbc0d12acda380b61c40825a

ã“ã®ãƒ‘ãƒƒãƒã®æ³¨æ„ç‚¹ã¯æ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã¨éæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã®æ··åœ¨ã¯ã§ããªã„ç‚¹ã§ã™ã€‚**ã‚¢ãƒ—ãƒªã®èª²é‡‘ã‚¢ã‚¤ãƒ†ãƒ ãŒã™ã¹ã¦éæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦æ‰¿èªã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€æ··åœ¨ã•ã›ãŸã„å ´åˆã¯ãƒ‘ãƒƒãƒã‚’æ›¸ãç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ã‚¨ãƒ³ã‚¸ãƒ³ã‚³ãƒ¼ãƒ‰ã¸ã®ãƒ‘ãƒƒãƒãªã®ã§è¤‡æ•°ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã‚‹å ´åˆã¯æ„å›³ã›ãšæ‰¿èªå‡¦ç†ãŒå…¥ã‚‰ãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚**

## Google Play Developer APIçµŒç”±ã§æ‰¿èªã™ã‚‹

APIã¸ã®æ¥ç¶šã‚’æƒ³å®šã—ã¦ã„ãªã„ã‚¢ãƒ—ãƒªã®å ´åˆã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ–°ã—ãé–‹ç™ºã—ã¦Unreal Engineã«REST APIæ¥ç¶šã¾ã‚ã‚Šã®è¿½åŠ ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã®ã§å°å…¥ã®é›£æ˜“åº¦ã¯é«˜ã‚ã§ã™ã€‚ã“ã¡ã‚‰ã¯æ¤œè¨¼ã¾ã§ã§ãã¦ã„ãªã„ã®ã§ç°¡å˜ã«èª¬æ˜ã™ã‚‹ã«ç•™ã‚ã¾ã™ã€‚

Google Play Develper APIã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®šã¯ä»¥ä¸‹ã‚’å‚è€ƒã«è¡Œã£ã¦ãã ã•ã„ã€‚

https://developers.google.com/android-publisher?hl=ja

ã‚ã‚‹è³¼å…¥ã‚’æ‰¿èªã™ã‚‹ã«ã¯`Method: purchases.products.acknowledge`ã«è¨˜è¼‰ã®REST APIã§è¡Œãˆã¾ã™ã€‚

https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.products/acknowledge?hl=ja

Path parametersã®tokenã¯`Transaction Identifier`ã€Request bodyã®developerPayloadã¯`""`ï¼ˆç©ºæ–‡å­—ï¼‰ã‚’æŒ‡å®šã—ã¦ã‚„ã‚Œã°å¤§ä¸ˆå¤«ã ã£ãŸã¨æ€ã„ã¾ã™ã€‚ï¼ˆã†ã‚è¦šãˆâ€¦â€¦ï¼‰

# ãƒ‘ãƒƒãƒã›ãšã«ãƒªãƒªãƒ¼ã‚¹ã—ã¦ã—ã¾ã£ãŸã¨ãã®å¯¾å¿œ

![](/images/20220215/play_console_notice.png)

ç½ ã«åµŒã£ã¦ã“ã®é€šçŸ¥ãŒæ¥ã¦ã‚‚è«¦ã‚ãªã„ã§ãã ã•ã„ã€‚Google Play Consoleã®æ³¨æ–‡ç®¡ç†ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—ã—ã¦Google Play Developer APIçµŒç”±ã§æ‰¿èªã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ãƒ‘ãƒƒãƒã‚’å½“ã¦ãŸãƒªãƒªãƒ¼ã‚¹ãŒå®Œäº†ã™ã‚‹ã¾ã§ã®é–“ã€ã“ã®æ–¹æ³•ã§æ‰•ã„æˆ»ã—ã‚’å›é¿ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãšã¯ä¸Šè¨˜åŒæ§˜ã«Google Play Developer APIã‚’åˆ©ç”¨ã™ã‚‹æº–å‚™ã‚’ã—ã¦ãã ã•ã„ã€‚

https://developers.google.com/android-publisher?hl=ja

Google Play Consoleã®ã€Œæ³¨æ–‡ç®¡ç†ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã“ã‚Œã¾ã§ã®æ³¨æ–‡ãŒä¸€è¦§ã§ãã¾ã™ï¼ˆã‚¢ãƒ—ãƒªå€‹åˆ¥ã®ãƒšãƒ¼ã‚¸ã§ã¯ãªãçµ„ç¹”ã®ãƒšãƒ¼ã‚¸ã«ã‚ã‚Šã¾ã™ï¼‰ã€‚å„æ³¨æ–‡ã®ä¸­ã«å…¥ã‚‹ã¨ã€Œè³¼å…¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ã€ã¨ã„ã†ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã€ã©ã“ã‹ã«æ§ãˆã¦ãŠãã¾ã™ã€‚ã¾ãŸã€ã“ã®æ³¨æ–‡ã®èª²é‡‘ã‚¢ã‚¤ãƒ†ãƒ IDï¼ˆSKUï¼š`com.some.thing.inapp1`ã¿ãŸã„ãªã‚„ã¤ï¼‰ã‚‚æ§ãˆã¦ãŠã„ã¦ãã ã•ã„ã€‚

ä¸‹è¨˜ã®`Method: purchases.products.get`ã‚’ä½¿ã£ã¦æ³¨æ–‡æƒ…å ±ã®è©³ç´°ã‚’ç¢ºèªã—ã¾ã™ã€‚packageNameã«ã¯ã‚¢ãƒ—ãƒªã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã€productIdã«ã¯å…ˆç¨‹æ§ãˆãŸèª²é‡‘ã‚¢ã‚¤ãƒ†ãƒ IDã€tokenã«ã¯ã‚³ãƒ”ãƒ¼ã—ãŸè³¼å…¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãã‚Œãã‚ŒæŒ‡å®šã—ã¾ã™ã€‚

https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.products/get?hl=ja

```
{
  "purchaseTimeMillis": "0000000000000",
  "purchaseState": 0,
  "consumptionState": 0,
  "developerPayload": "",
  "orderId": "GPA.XXX-XXXX-XXXX-XXXXX",
  "purchaseType": 0,
  "acknowledgementState": 0,
  "kind": "androidpublisher#productPurchase",
  "regionCode": "JP"
}
```

:::message
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ã—ã„èª¬æ˜ã¯ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.products?hl=ja#ProductPurchase
:::

ã™ã‚‹ã¨ã€ã“ã‚“ãªæ„Ÿã˜ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã™ã€‚ã“ã®ã†ã¡`purchaseState = 0`ã€`acknowledgementState = 0`ãŒæ”¯æ‰•ã„ãŒçµ‚ã‚ã£ã¦ã„ã‚‹ã®ã«æ‰¿èªã•ã‚Œã¦ãªã„æ³¨æ–‡ã«ãªã‚Šã¾ã™ã€‚ã“ã®æ³¨æ–‡ã«å¯¾ã—ã¦`Method: purchases.products.acknowledge`ã‚’å®Ÿè¡Œã—ã¦ã‚ã’ã‚Œã°ã€æ‰•ã„æˆ»ã•ã‚Œãšã«æ¸ˆã¿ã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- Path parameters
  - `packageName = ã‚¢ãƒ—ãƒªã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å`
  - `productId = èª²é‡‘ã‚¢ã‚¤ãƒ†ãƒ ã®SKU`
  - `token = è³¼å…¥ãƒˆãƒ¼ã‚¯ãƒ³`
- Request body
  - `{ "developerPayload": "" }`

:::message
developerPayloadã¯ä¸Šè¨˜ã®é€šã‚Šç©ºæ–‡å­—ã§å¤§ä¸ˆå¤«ã§ã™ã€‚
:::

https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.products/acknowledge?hl=ja

`Method: purchases.products.acknowledge`ã‚’å®Ÿè¡Œå¾Œã«ã‚‚ã†ä¸€åº¦åŒã˜æ³¨æ–‡ã§`Method: purchases.products.get`ã‚’å®Ÿè¡Œã—ã€`acknowledgementState = 1`ã«ãªã£ã¦ã„ã‚Œã°æˆåŠŸã§ã™ã€‚

ãŸã ã—æ³¨æ–‡ã®ä¸€è¦§å–å¾—APIã¯ç”¨æ„ã•ã‚Œã¦ã„ãªã„ã®ã§æ³¨æ–‡ç®¡ç†ã‹ã‚‰æ‰‹å‹•ã§èª²é‡‘ã‚¢ã‚¤ãƒ†ãƒ IDã¨è³¼å…¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é›†ã‚ã€ã²ã¨ã¤ãšã¤å®Ÿè¡Œã—ã¦ã„ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ•°ãŒå¤šã„å ´åˆã¯å¤§å¤‰ã§ã™ã®ã§ã€ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹å‰ã«ã‚¢ãƒ—ãƒªå´ã§éæ¶ˆè²»å‹ã‚¢ã‚¤ãƒ†ãƒ ã®æ‰¿èªå‡¦ç†ã«å¯¾å¿œã—ã¦ã€ã—ã£ã‹ã‚Šæ¤œè¨¼ã—ã¦ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

---

ã“ã®å•é¡Œã«å¯¾ã—ã¦ã¯2021å¹´10æœˆã«Forumã«Feature RequestãŒå‡ºã¦ã„ã¾ã™ãŒã€ç¾çŠ¶è¿”ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°æ©Ÿèƒ½ã¨ã„ã†ã‚ˆã‚ŠAcknowledgeå‡¦ç†ãŒã§ããªã„ã®ã¯æ™®é€šã«ãƒã‚°ã ã¨æ€ã†ã®ã§ä¿®æ­£ã—ã¦ã»ã—ã„ã¨ã“ã‚ã§ã™ã€‚

https://forums.unrealengine.com/t/feature-request-google-payment-api-fixes-for-acknowledging-a-purchase/254121

# å‚è€ƒ

https://forums.unrealengine.com/t/android-letting-me-purchase-a-non-consumable-product-more-than-1-time/225684/10
