---
title: "Node.jsã‚’ä½¿ã£ã¦Firestoreã‚’ç›£è¦–ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãæ›ãˆã‚‹"
emoji: "ğŸ‘€"
type: "tech"
topics: ["firebase", "firestore", "gcp", "nodejs"]
published: true
---

Raspberry Pi ã‚„ Jetson ãªã©ã®ãƒã‚¤ã‚¯ãƒ­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ä½•ã‹ã‚’ã™ã‚‹ã¨ãã«ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§å¤–ã‹ã‚‰è¨­å®šå€¤ã‚’å¤‰ãˆãŸã„ã“ã¨ã£ã¦ã‚ˆãã‚ã‚Šã¾ã™ã‚ˆã­ï¼Ÿï¼ˆãªã„ï¼‰

ãã‚“ãªã¨ãã«ä½¿ãˆã‚‹ã®ãŒGoogleã®FirebaseãŒæä¾›ã™ã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ŒCloud Firestoreã€ã§ã™ã€‚æ•°è¡Œã®ã‚³ãƒ¼ãƒ‰ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãŒFirebaseå†…ã«ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æ›´æ–°ã¯ãã‚Œã§ã‚„ã£ã¦ã—ã¾ãˆã°ã€Firestoreã®æ›´æ–°ã®ç›£è¦–ã‚’ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã ã‘ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§è¨­å®šå€¤ã‚’å¤‰ãˆã‚‹ä»•çµ„ã¿ãŒä½œã‚Œã¾ã™ã€‚

ä»Šå›ã¯ã€Node.jsã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãæ›ãˆã‚‹æ–¹æ³•ã§ã‚„ã£ã¦ã¿ã‚‹æ–¹æ³•ã‚’ç°¡å˜ã«ç´¹ä»‹ã—ã¾ã™ã€‚

# äº‹å‰æº–å‚™

Firebaseã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦ã€Cloud Firestoreã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚æ—¥æœ¬ã§å®Ÿè¡Œã™ã‚‹ãªã‚‰ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€Œasia-northeast1ã€ã¨ã‹ã§è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

ãã®å¾Œã€Cloud Firestoreã«ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚ä»Šå›ã¯ã‚µãƒ³ãƒ—ãƒ«ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ä½œã‚Šã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/unfcg6xenf26tqjlzxod4gz15sle)

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ãƒ«ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ãŠãã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

```
service cloud.firestore {
 match /databases/{database}/documents {
   match /{document=**} {
     allow read, write: if request.auth.uid != null;
   }
 }
}
```

Firebaseã®ç§˜å¯†éµã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã®ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã®ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ¨©é™ï¼ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼Firebase Admin SDKã€ã®æ–°ã—ã„ç§˜å¯†éµã®ç”Ÿæˆã‚’ã—ã¦ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸJsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’Node.jsã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ãªã©ã«ç½®ã„ã¦ãã ã•ã„ã€‚

# package.json

ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã®å¼•æ•°ã‚’ç°¡å˜ã«æ‰±ãˆã‚‹commanderã¨Firestoreã‚’ä½¿ã†ãŸã‚ã«firebase-adminã‚’ä½¿ã„ã¾ã™ã€‚

```json
{
 "name": "remote-sttings",
 "description": "Listen to a firestore collection and update a local setting file.",
 "main": "watch.js",
 "scripts": {
   "test": "echo \"Error: no test specified\" && exit 1"
 },
 "dependencies": {
   "commander": "^2.20.0",
   "firebase-admin": "^8.2.0"
 }
}
```

# watch.js

```js
#!/usr/bin/env node

const program = require('commander');
const fs = require('fs');

const credentialPath = './serviceAccountKey.json'
let outputFilePath = './output/settings.json';

program
 .option('-o, --out [path]', 'A path to an output file.')
 .parse(process.argv);

if(program.out) outputFilePath = program.out;

const admin = require('firebase-admin');
const serviceAccount = require(credentialPath);

// Firebaseã®åˆæœŸåŒ–
admin.initializeApp({
 credential: admin.credential.cert(serviceAccount)
})

const db = admin.firestore()

console.log('[INFO] Start listen to Firestore.')

// Firebaseã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è³¼èª­
const unsub = db.collection('settings').doc('test').onSnapshot(snapshot => {
 console.log('[INFO] Firestore settings are changed.')
 console.log(snapshot.data())

 // JSONã‚’æ–‡å­—åˆ—ã«å¤‰æ›
 data = JSON.stringify(snapshot.data(), null, 2)

 // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—
 fs.writeFile(outputFilePath, data, 'utf8', (error) => {
   if (error) {
     console.error(`[ERROR] Can't update ${outputFilePath}.`);
     console.error(`[ERROR] ${error}`)
     process.exit(1)
   } else {
     console.log(`[INFO] ${outputFilePath} was updated.`)
   }
 })
}, error => {
 console.error(`[ERROR] Can't observe firestore document.`)
 console.error(`[ERROR] ${error}`)
 process.exit(1)
})

// Node.jsã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’å¾…æ©Ÿã•ã›ã‚‹
const reader = require('readline').createInterface({
 input: process.stdin,
 output: process.stdout
});

reader.on('close', function () {
 unsub()
 console.log('[EXIT]');
});
```

ã‚ã¨ã¯ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§å®Ÿè¡Œã™ã‚Œã°ã€Firestoreã®å€¤ãŒå¤‰æ›´ã•ã‚Œã‚‹ãŸã³ã«ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›¸ãæ›ã‚ã‚Šã¾ã™ã€‚

```
$ node watch.js
```

# æ–™é‡‘

[ä½¿ç”¨é‡ã¨åˆ¶é™ Â |Â  Firebase](https://firebase.google.com/docs/firestore/quotas?hl=ja)

ã“ã“ã«ç„¡æ–™ã®å‰²å½“ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚å€‹äººçš„ãªç”¨é€”ã§ä½¿ã†åˆ†ã«ã¯ç„¡æ–™ã§ä½¿ãˆã‚‹å‰²ã‚Šå½“ã¦é‡ã ã¨æ€ã„ã¾ã™ã€‚

ã“ã‚“ãªä»•çµ„ã¿ãŒServerlessã§ã‚‚ã®ã®1æ™‚é–“ç¨‹åº¦ã§ä½œã‚Œã¦ã—ã¾ã†ã®ã¯æœ¬å½“ã«ä¾¿åˆ©ãªä¸–ã®ä¸­ã§ã™ã€‚

ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯Githubã«ã‚‚ä¸Šã’ã¦ã„ã¾ã™ã®ã§ã€å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚Firebaseã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã®å–ã‚Šæ‰±ã„ã«ã¯ååˆ†æ°—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚

[dforest/firestore-nodejs-sample](https://github.com/dforest/firestore-nodejs-sample)