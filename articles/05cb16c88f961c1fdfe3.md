---
title: "Android Architecture Componentsã§çŠ¯ã—ãŒã¡ãª5ã¤ã®é–“é•ã„ã€ç¿»è¨³ã€‘"
emoji: "ğŸ™ˆ"
type: "tech"
topics: ["android", "kotlin"]
published: true
---

ã“ã®è¨˜äº‹ã¯è‘—è€… MichaÅ‚ Baran([@BaranMichal25](https://twitter.com/BaranMichal25)) æ°ã®è¨±å¯ã‚’å¾—ã¦ç¿»è¨³ã—ãŸã‚‚ã®ã§ã™ã€‚

Original article: [5 common mistakes when using Architecture Components](https://proandroiddev.com/5-common-mistakes-when-using-architecture-components-403e9899f4cb)

---

å¤§ãªã‚Šå°ãªã‚Šé‡å¤§ãªçµæœã‚’å¼•ãèµ·ã“ã™å¾®å¦™ãªé–“é•ã„ã¯ï¼ˆãŸã¨ãˆãã®ã‚ˆã†ãªé–“é•ã„ã‚’çŠ¯ã—ã¦ã“ãªã‹ã£ãŸã¨ã—ã¦ã‚‚ï¼‰ã€å°†æ¥èµ·ã“ã‚‹ã‹ã‚‚çŸ¥ã‚Œãªã„å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€é ­ã«å…¥ã‚Œã¦ãŠã„ãŸã»ã†ãŒè‰¯ã„ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ä»¥ä¸‹ã®çŠ¯ã—ãŒã¡ãª5ã¤ã®é–“é•ã„ã«ã¤ã„ã¦è§£èª¬ã™ã‚‹ã€‚

- Fragmentã§ã®LiveData observerã®ãƒªãƒ¼ã‚¯
- ç”»é¢ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒªãƒ­ãƒ¼ãƒ‰
- ViewModelã®ãƒªãƒ¼ã‚¯
- MutableãªLiveDataã®Viewã¸ã®å…¬é–‹
- æ§‹æˆãŒå¤‰ã‚ã‚‹åº¦ã«å†ä½œæˆã•ã‚Œã‚‹ViewModelã®ä¾å­˜é–¢ä¿‚

 # 1. Fragmentã§ã®LiveData observerã®ãƒªãƒ¼ã‚¯
 
Fragmentã¯ãƒˆãƒªãƒƒã‚­ãƒ¼ãªãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’æŒã£ã¦ã„ã¦ã€detachã‚„re-attachã§å¸¸ã«ç ´æ£„ã•ã‚Œã‚‹è¨³ã§ã¯ãªã„ã€‚ä¾‹ãˆã°ã€ä¿æŒã•ã‚ŒãŸFragmentã¯æ§‹æˆã®å¤‰æ›´ã§ã¯ç ´æ£„ã•ã‚Œãªã„ã€‚ã“ã‚ŒãŒèµ·ãã‚‹ã¨ã€Fragmentã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ç”Ÿãæ®‹ã‚Šã€Viewã ã‘ãŒç ´æ£„ã•ã‚Œã‚‹ã€‚ãã—ã¦`onDestory()`ã¯å‘¼ã°ã‚Œãšã€DESTROYEDã®çŠ¶æ…‹ã«é”ã—ãªã„ã€‚

ã“ã‚ŒãŒã©ã†ã„ã†ã“ã¨ã‹ã¨ã„ã†ã¨ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«LiveDataã‚’`onCreateView()`ã‚„ãã‚Œä»¥å¾Œï¼ˆã‚ˆãã‚ã‚‹ã®ã¯`onActivityCreated()`ï¼‰ã§LifecycleOwnerã¨ã—ã¦Fragmentã‚’æ¸¡ã—ã¦ç›£è¦–ã—å§‹ã‚ãŸã¨ãã«ã€å•é¡ŒãŒèµ·ãã‚‹ã€‚

```kotlin
class BooksFragment: Fragment() {

    private lateinit var viewModel: BooksViewModel

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
        return inflater.inflate(R.layout.fragment_books, container)
    }

    override fun onActivityCreated(savedInstanceState: Bundle?) {
        super.onActivityCreated(savedInstanceState)
        viewModel = ViewModelProviders.of(this).get(BooksViewModel::class.java)

        viewModel.liveData.observe(this, Observer { updateViews(it) })  // Risky: Passing Fragment as LifecycleOwner
    }
    
    ...
}
```
[from gist](https://gist.github.com/BaranMichal25/ab2a869c3e30a783e5ee10eaedef7ead#file-booksfragment-kt)

ã“ã‚Œã¯FragmentãŒå†é©ç”¨ã•ã‚Œã‚‹åº¦ã«æ–°ã—ã„Observerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¸¡ã™ã“ã¨ã«ãªã‚‹ãŒã€LiveDataã¯å‰ã®Observerã‚’ç ´æ£„ã—ãªã„ã€‚ãªãœãªã‚‰ã€LifecycleOwnerï¼ˆã“ã®ä¾‹ã ã¨Fragmentï¼‰ã¯DESTROYEDã®çŠ¶æ…‹ã«ãªã£ã¦ã„ãªã„ã€‚æœ€çµ‚çš„ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªObseverã®æ•°ãŒã©ã‚“ã©ã‚“å¢—ãˆã¦ã„ãã€`onChanged()`ã§åŒã˜ã‚³ãƒ¼ãƒ‰ãŒä½•åº¦ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ã€‚

ã“ã®å•é¡Œã¯ã‚‚ã¨ã‚‚ã¨[ã“ã“](https://github.com/googlesamples/android-architecture-components/issues/47)ã§å ±å‘Šã•ã‚Œã€ã•ã‚‰ã«è©³ã—ã„èª¬æ˜ãŒ[ã“ã“](https://medium.com/@BladeCoder/architecture-components-pitfalls-part-1-9300dd969808)ã«ã‚ã‚‹ã€‚

ãŠã™ã™ã‚ã®è§£æ±ºæ–¹æ³•ã¯Fragmentã®View Lifecycleã«ã¯ã€Support Library 28.0.0ã¨AndroidX 1.0.0ã§è¿½åŠ ã•ã‚ŒãŸ [getViewLifecycleOwner()](https://developer.android.com/reference/androidx/fragment/app/Fragment#getViewLifecycleOwner%28%29) ã‹ [getViewLifecycleOwnerLiveData()](https://developer.android.com/reference/androidx/fragment/app/Fragment#getviewlifecycleownerlivedata) ã‚’ä½¿ã†ã“ã¨ã ã€‚ã“ã‚Œã§LiveDataã¯Fragmentã®ViewãŒç ´æ£„ã•ã‚Œã‚‹åº¦ã«Observerã‚‚ç ´æ£„ã—ã¦ãã‚Œã‚‹ã€‚

```kotlin
class BooksFragment : Fragment() {

    ...

    override fun onActivityCreated(savedInstanceState: Bundle?) {
        super.onActivityCreated(savedInstanceState)
        viewModel = ViewModelProviders.of(this).get(BooksViewModel::class.java)

        viewModel.liveData.observe(viewLifecycleOwner, Observer { updateViews(it) })    // Usually what we want: Passing Fragment's view as LifecycleOwner
    }
    
    ...
}
```
[from gist](https://gist.github.com/BaranMichal25/c30c8a4a196ba622467c8d2758728b3c#file-booksfragment-kt)

# 2. ç”»é¢ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒªãƒ­ãƒ¼ãƒ‰

Activityã®åˆæœŸåŒ–ã‚„ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯`onCreate()`(Fragmentã ã¨`onCreateView()`ã‹ãã‚Œä»¥å¾Œ)ã«æ›¸ãã“ã¨ãŒå¤šã„ã€‚ãã—ã¦ãã“ã«ã€ViewModelã‚’ä»‹ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã‚‚æ›¸ããŸããªã‚‹ã€‚ã—ã‹ã—ãã“ã«æ›¸ã„ãŸã“ã¨ã§ã€ï¼ˆViewModelã‚’ä½¿ã£ã¦ã„ãŸã¨ã—ã¦ã‚‚ï¼‰ç”»é¢ãŒãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹åº¦ã«ãƒ‡ãƒ¼ã‚¿ã®ãƒªãƒ­ãƒ¼ãƒ‰ãŒç™ºç”Ÿã—ã¦ã—ã¾ã†ã€‚ã“ã‚Œã¯ã»ã¨ã‚“ã©ã®å ´åˆã€ç„¡æ„è­˜ã«æ„å›³ã›ãšèµ·ã“ã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ã€‚

```kotlin
class ProductViewModel(
    private val repository: ProductRepository
) : ViewModel() {

    private val productDetails = MutableLiveData<Resource<ProductDetails>>()
    private val specialOffers = MutableLiveData<Resource<SpecialOffers>>()

    fun getProductsDetails(): LiveData<Resource<ProductDetails>> {
        repository.getProductDetails()  // Loading ProductDetails from network/database
        ...                             // Getting ProductDetails from repository and updating productDetails LiveData
        return productDetails
    }

    fun loadSpecialOffers() {
        repository.getSpecialOffers()   // Loading SpecialOffers from network/database
        ...                             // Getting SpecialOffers from repository and updating specialOffers LiveData
    }
}

class ProductActivity : AppCompatActivity() {

    lateinit var productViewModelFactory: ProductViewModelFactory

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val viewModel = ViewModelProviders.of(this, productViewModelFactory).get(ProductViewModel::class.java)

        viewModel.getProductsDetails().observe(this, Observer { /*...*/ })  // (probable) Reloading product details after every rotation
        viewModel.loadSpecialOffers()                                       // (probable) Reloading special offers after every rotation
    }
}
```
[from gist](https://gist.github.com/BaranMichal25/e333a397908f0f169373c9638f91b269#file-productactivity-kt)

ã“ã®è§£æ±ºæ–¹æ³•ã¯å®Ÿè£…ã«ã‚ˆã‚‹ã€‚ä¾‹ãˆã°ã€RepositoryãŒãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã„ã‚‹å ´åˆã€ä¸Šã®ã‚³ãƒ¼ãƒ‰ã§å•é¡Œãªã„ã€‚

- [AbsentLiveData](https://github.com/googlesamples/android-architecture-components/blob/master/GithubBrowserSample/app/src/main/java/com/android/example/github/util/AbsentLiveData.kt)ã®ã‚ˆã†ãªã‚‚ã®ã‚’ä½¿ã£ã¦ã€ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã¨ãã«ã ã‘ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
- å®Ÿéš›ã«å¿…è¦ã«ãªã£ãŸã¨ãï¼ˆOnClickListenerã®ä¸­ãªã©ï¼‰ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
- æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªã®ãŒã€ViewModelã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã§ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’ã—ã¦ã€ç´”ç²‹ãªGetterã ã‘å…¬é–‹ã™ã‚‹

```kotlin
class ProductViewModel(
    private val repository: ProductRepository
) : ViewModel() {

    private val productDetails = MutableLiveData<Resource<ProductDetails>>()
    private val specialOffers = MutableLiveData<Resource<SpecialOffers>>()

    init {
        loadProductsDetails()           // ViewModel is created only once during Activity/Fragment lifetime
    }

    private fun loadProductsDetails() { // private, just utility method to be invoked in constructor
        repository.getProductDetails()  // Loading ProductDetails from network/database
        ...                             // Getting ProductDetails from repository and updating productDetails LiveData
    }

    fun loadSpecialOffers() {           // public, intended to be invoked by other classes when needed
        repository.getSpecialOffers()   // Loading SpecialOffers from network/database
        ...                             // Getting SpecialOffers from repository and updating _specialOffers LiveData
    }

    fun getProductDetails(): LiveData<Resource<ProductDetails>> {   // Simple getter
        return productDetails
    }

    fun getSpecialOffers(): LiveData<Resource<SpecialOffers>> {     // Simple getter
        return specialOffers
    }
}

class ProductActivity : AppCompatActivity() {

    lateinit var productViewModelFactory: ProductViewModelFactory

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val viewModel = ViewModelProviders.of(this, productViewModelFactory).get(ProductViewModel::class.java)

        viewModel.getProductDetails().observe(this, Observer { /*...*/ })    // Just setting observer
        viewModel.getSpecialOffers().observe(this, Observer { /*...*/ })     // Just setting observer

        button_offers.setOnClickListener { viewModel.loadSpecialOffers() }
    }
}
```
[from gist](https://gist.github.com/BaranMichal25/3789c1a05a55c83a8bc3a8230bace5e3#file-productactivity-kt)

# 3. ViewModelã®ãƒªãƒ¼ã‚¯

ViewModelã«Viewã®å‚ç…§ã‚’æ¸¡ã™ã¹ãã§ã¯ãªã„ã“ã¨ã¯ã€[ã™ã§ã«å–ã‚Šä¸Šã’ã‚‰ã‚Œã¦ã„ã‚‹ã€‚](https://developer.android.com/topic/libraries/architecture/viewmodel#implement)

![](https://storage.googleapis.com/zenn-user-upload/05grrtqypez107c25pi2uumzrddv)

ã•ã‚‰ã«ViewModelã«ä»–ã®ã‚¯ãƒ©ã‚¹ã®å‚ç…§ã‚’æ¸¡ã™ã“ã¨ã«ã‚‚ã€æ…é‡ã«ãªã£ãŸã»ã†ãŒè‰¯ã„ã€‚Activityï¼ˆã‚„Fragmentï¼‰ãŒçµ‚äº†ã—ãŸã‚ã¨ã€ViewModelã¯ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ã«ç ´æ£„ã•ã‚Œã‚‹ã®ã§ã€ViewModelã¯Activityã‚ˆã‚Šã‚‚é•·ç”Ÿãã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‚ç…§ã‚’æŒã¤ã¹ãã§ã¯ãªã„ã€‚

ã“ã®ä¾‹ã§ã¯ã€ViewModelã§ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã®Repositoryã«ãƒªã‚¹ãƒŠãƒ¼ã‚’æ¸¡ã—ã¦ã„ã¦ã€ãã®å¾Œå‚ç…§ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ãªã„ã®ã§ã€ãƒªãƒ¼ã‚¯ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

```kotlin
@Singleton
class LocationRepository() {

    private var listener: ((Location) -> Unit)? = null

    fun setOnLocationChangedListener(listener: (Location) -> Unit) {
        this.listener = listener
    }

    private fun onLocationUpdated(location: Location) {
        listener?.invoke(location)
    }
}


class MapViewModel: AutoClearViewModel() {

    private val liveData = MutableLiveData<LocationRepository.Location>()
    private val repository = LocationRepository()

    init {
        repository.setOnLocationChangedListener {   // Risky: Passing listener (which holds reference to the MapViewModel)
            liveData.value = it                     // to singleton scoped LocationRepository
        }
    }
}
```
[from gist](https://gist.github.com/BaranMichal25/649a29e24f3dfc54153167ef9eaac800#file-viewmodelleak-kt)

ã“ã®è§£æ±ºæ–¹æ³•ã§ã¯ã€Repositoryã§ã¯å¼±ã„å‚ç…§ã§æŒã¡ã€Repositoryã¨ViewModelé–“ã§ã‚„ã‚Šã¨ã‚Šã—ã¦ã€`onCleared()`ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒªã‚¹ãƒŠãƒ¼ã‚’ç ´æ£„ã—ã¦ã„ã‚‹ã€‚åŸºæœ¬çš„ã«ã¯æ­£ã—ãã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã•ã‚Œã‚Œã°ã‚„ã‚Šã‚„ã™ã„æ–¹æ³•ã§è‰¯ã„ã€‚

```kotlin
@Singleton
class LocationRepository() {

    private var listener: ((Location) -> Unit)? = null

    fun setOnLocationChangedListener(listener: (Location) -> Unit) {
        this.listener = listener
    }

    fun removeOnLocationChangedListener() {
        this.listener = null
    }

    private fun onLocationUpdated(location: Location) {
        listener?.invoke(location)
    }
}


class MapViewModel: AutoClearViewModel() {

    private val liveData = MutableLiveData<LocationRepository.Location>()
    private val repository = LocationRepository()

    init {
        repository.setOnLocationChangedListener {   // Risky: Passing listener (which holds reference to the MapViewModel)
            liveData.value = it                     // to singleton scoped LocationRepository
        }
    }
  
    override onCleared() {                            // GOOD: Listener instance from above and MapViewModel
        repository.removeOnLocationChangedListener()  //       can now be garbage collected
    }  
}
```
[from gist](https://gist.github.com/BaranMichal25/849471dcf133678314d33db9e6570d32#file-viewmodelleakcleared-kt)

# 4. MutableãªLiveDataã®Viewã¸ã®å…¬é–‹

ã“ã‚Œã¯ãƒã‚°ã§ã¯ãªã„ãŒã€é–¢å¿ƒäº‹ã®åˆ†é›¢ã«åã—ã¦ã„ã‚‹ã€‚Fragmentã‚„Activityãªã©ã®Viewã¯LiveDataã‚„ã“è‡ªèº«ã®çŠ¶æ…‹ã‚’æ›´æ–°ã§ãã‚‹ã¹ãã§ã¯ãªã„ã€‚ãªãœãªã‚‰ãã‚Œã¯ViewModelã®è²¬å‹™ã ã‹ã‚‰ã ã€‚Viewã¯LiveDataã®ç›£è¦–ã ã‘ã‚’ã™ã‚‹ã¹ãã ã€‚

ã—ãŸãŒã£ã¦ã€MutableLiveDataã¯ä¾‹ãˆã°Getterã‚„ãƒãƒƒã‚­ãƒ³ã‚°ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãªã©ã§ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã¹ãã§ã‚ã‚‹ã€‚

```kotlin
class CatalogueViewModel : ViewModel() {

    // BAD: Exposing mutable LiveData
    val products = MutableLiveData<Products>()


    // GOOD: Encapsulate access to mutable LiveData through getter
    private val promotions = MutableLiveData<Promotions>()

    fun getPromotions(): LiveData<Promotions> = promotions


    // GOOD: Encapsulate access to mutable LiveData using backing property
    private val _offers = MutableLiveData<Offers>()
    val offers: LiveData<Offers> = _offers


    fun loadData(){
        products.value = loadProducts()     // Other classes can also set products value
        promotions.value = loadPromotions() // Only CatalogueViewModel can set promotions value
        _offers.value = loadOffers()        // Only CatalogueViewModel can set offers value
    }
}
```
[from gist](https://gist.github.com/BaranMichal25/f7a73c8df17baec3b46a73ebbce04d23#file-catalogueviewmodel-kt)

# 5. æ§‹æˆãŒå¤‰ã‚ã‚‹åº¦ã«å†ä½œæˆã•ã‚Œã‚‹ViewModelã®ä¾å­˜é–¢ä¿‚

ViewModelã¯ç”»é¢ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ˆã†ãªæ§‹æˆã®å¤‰æ›´ãŒã‚ã£ã¦ã‚‚ç”Ÿãæ®‹ã‚‹ã€‚ãã®ãŸã‚å¤‰æ›´ãŒç”Ÿã˜ã‚‹åº¦ã«ä¾å­˜é–¢ä¿‚ã‚’ä½œã‚‹ã®ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å†—é•·ã ã—ã€ç‰¹ã«ä¾å­˜é–¢ä¿‚ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ãƒ­ã‚¸ãƒƒã‚¯ã§æ„å›³ã—ãªã„å‹•ãã‚’ã—ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹ã€‚ã“ã‚Œã¯ã‹ãªã‚Šæ˜ç™½ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ä½œæˆã™ã‚‹ViewModelã¨åŒã˜ä¾å­˜é–¢ä¿‚ã‚’æŒã¤ã€ViewModelFactoryã‚’ä½¿ã†ã¨ãã«è¦‹è½ã¨ã—ã‚„ã™ã„ã€‚

ViewModelProviderã¯ViewModelã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹ãŒã€ViewModelFactoryã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ä¿æŒã—ãªã„ã€‚ãªã®ã§ã€ã“ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã¨å•é¡ŒãŒèµ·ãã‚‹ã€‚

```kotlin

class MoviesViewModel(
    private val repository: MoviesRepository,
    private val stringProvider: StringProvider,
    private val authorisationService: AuthorisationService
) : ViewModel() {
    
    ...
}


class MoviesViewModelFactory(   // We need to create instances of below dependencies to create instance of MoviesViewModelFactory
    private val repository: MoviesRepository,
    private val stringProvider: StringProvider,
    private val authorisationService: AuthorisationService
) : ViewModelProvider.Factory {

    override fun <T : ViewModel> create(modelClass: Class<T>): T {  // but this method is called by ViewModelProvider only if ViewModel wasn't already created
        return MoviesViewModel(repository, stringProvider, authorisationService) as T
    }
}


class MoviesActivity : AppCompatActivity() {

    @Inject
    lateinit var viewModelFactory: MoviesViewModelFactory

    private lateinit var viewModel: MoviesViewModel

    override fun onCreate(savedInstanceState: Bundle?) {    // Called each time Activity is recreated
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_movies)

        injectDependencies() // Creating new instance of MoviesViewModelFactory

        viewModel = ViewModelProviders.of(this, viewModelFactory).get(MoviesViewModel::class.java)
    }
    
    ...
}
```
[from gist](https://gist.github.com/BaranMichal25/b99f773fe15f3880df94d0861391d5e7#file-moviesviewmodel-kt)

æ§‹æˆã®å¤‰æ›´ãŒã‚ã‚‹åº¦ã«ã€ViewModelFactoryã®æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã€ãã‚Œã«å¾“ã£ã¦ä¸å¿…è¦ãªã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆãã‚ŒãŒä½•ã‚‰ã‹ã®å½¢ã§ã‚¹ã‚³ãƒ¼ãƒ—ã•ã‚Œã¦ãªã„ã¨ä»®å®šï¼‰ã€‚

ã“ã®ã¨ãã®è§£æ±ºç­–ã¯`create()`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿéš›ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã¾ã§ã€ä¾å­˜é–¢ä¿‚ã®ä½œæˆã‚’ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã ã€‚ãã†ã™ã‚Œã°Activityã¨FragmentãŒç”Ÿãã¦ã„ã‚‹é–“ã«1å›ã—ã‹å‘¼ã³å‡ºã•ã‚Œãªã„ã€‚ä¾‹ãˆã°Providerãªã©ã‚’ä½¿ã£ã¦åˆæœŸåŒ–ã‚’é…å»¶ã•ã›ã‚‹ã“ã¨ã§è§£æ±ºã§ãã‚‹ã€‚

```kotlin
class MoviesViewModel(
    private val repository: MoviesRepository,
    private val stringProvider: StringProvider,
    private val authorisationService: AuthorisationService
) : ViewModel() {
    
    ...
}


class MoviesViewModelFactory(
    private val repository: Provider<MoviesRepository>,             // Passing Providers here 
    private val stringProvider: Provider<StringProvider>,           // instead of passing directly dependencies
    private val authorisationService: Provider<AuthorisationService>
) : ViewModelProvider.Factory {

    override fun <T : ViewModel> create(modelClass: Class<T>): T {  // This method is called by ViewModelProvider only if ViewModel wasn't already created
        return MoviesViewModel(repository.get(),                    
                               stringProvider.get(),                // Deferred creating dependencies only if new insance of ViewModel is needed
                               authorisationService.get()
                              ) as T
    }
}


class MoviesActivity : AppCompatActivity() {

    @Inject
    lateinit var viewModelFactory: MoviesViewModelFactory

    private lateinit var viewModel: MoviesViewModel

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_movies)
      
        injectDependencies() // Creating new instance of MoviesViewModelFactory

        viewModel = ViewModelProviders.of(this, viewModelFactory).get(MoviesViewModel::class.java)
    }
    
    ...
}
```
[from gist](https://gist.github.com/BaranMichal25/92eac160f38ac4c36d1d3d850fd4103d#file-moviesviewmodel-kt)

# å‚è€ƒè³‡æ–™

- [ViewModels and LiveData: Patterns + AntiPatterns](https://medium.com/androiddevelopers/viewmodels-and-livedata-patterns-antipatterns-21efaef74a54)
- [Architecture Components pitfalls â€” Part 1](https://medium.com/@BladeCoder/architecture-components-pitfalls-part-1-9300dd969808)
- [Android Architecture Blueprints](https://github.com/googlesamples/android-architecture)
- [7 Pro-tips for Room](https://medium.com/androiddevelopers/7-pro-tips-for-room-fbadea4bfbd1)
- [Official documentation](https://developer.android.com/topic/libraries/architecture/)

---

ã“ã®è¨˜äº‹ã¯è‘—è€… MichaÅ‚ Baran([@BaranMichal25](https://twitter.com/BaranMichal25)) æ°ã®è¨±å¯ã‚’å¾—ã¦ç¿»è¨³ã—ãŸã‚‚ã®ã§ã™ã€‚é–“é•ã„ãŒã‚ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‹ã€[@d_forest](https://twitter.com/d_forest)ã¾ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚

Original article: [5 common mistakes when using Architecture Components](https://proandroiddev.com/5-common-mistakes-when-using-architecture-components-403e9899f4cb)

Thank you MichaÅ‚!

@[tweet](https://twitter.com/BaranMichal25/status/1159069748036014081)
